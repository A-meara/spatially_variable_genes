Bootstrap: localimage
From: python_base_ob.sif

%post
    # Install Python packages for SOMDE
    # Install numpy and build dependencies first
    # Pin scipy to version that still has scipy.misc.derivative (removed in 1.14+)
    pip install --no-cache-dir --break-system-packages \
        numpy \
        "scipy<1.14" \
        setuptools \
        wheel \
        Cython

    # Install somoclu separately with --no-build-isolation so it can access numpy
    pip install --no-cache-dir --break-system-packages --no-build-isolation somoclu

    # Now install somde and other dependencies
    pip install --no-cache-dir --break-system-packages \
        somde \
        scanpy \
        pandas

    # Fix somde's util.py - replace sp.<numpy_func> with np.<numpy_func>
    # (these numpy functions were exposed in old scipy but no longer exist)
    SOMDE_UTIL=$(python3 -c "import somde; import os; print(os.path.join(os.path.dirname(somde.__file__), 'util.py'))")
    sed -i 's/sp\.arange/np.arange/g' "$SOMDE_UTIL"
    sed -i 's/sp\.array/np.array/g' "$SOMDE_UTIL"
    sed -i 's/sp\.argsort/np.argsort/g' "$SOMDE_UTIL"
    sed -i 's/sp\.zeros_like/np.zeros_like/g' "$SOMDE_UTIL"

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%labels
    Author OpenProblems/Aidan Meara
    Version 1.0.0

%help
    SOMDE method for spatially variable gene detection
    Based on openproblems/base_python:1.0.0
