Bootstrap: localimage
From: base_tensorflow_nvidia.sif

%post
    # Install git (already in base but ensure it's there)
    apt-get update && apt-get install -y git

    # Upgrade typing_extensions for compatibility with omnibenchmark/pydantic
    pip install --no-cache-dir --break-system-packages --upgrade typing_extensions

    # Install Python packages for GPcounts
    # Pin tensorflow-probability to 0.24.0 which is compatible with TensorFlow 2.17
    pip install --no-cache-dir --break-system-packages \
        "tensorflow-probability==0.24.0" \
        tensorflow[and-cuda] \
        gpflow \
        scipy

    # Clone and install RobustGP and GPcounts
    git clone https://github.com/markvdw/RobustGP.git /opt/RobustGP
    git clone https://github.com/lzj1769/GPcounts.git /opt/GPcounts

    pip install --no-cache-dir --break-system-packages \
        /opt/RobustGP \
        /opt/GPcounts

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%labels
    Author "OpenProblems/Aidan Meara"
    Version "1.0.0"
    Description "GPcounts method for spatially variable gene detection"
    BaseImage "base_tensorflow_nvidia.sif (TensorFlow 25.01, Python 3.12)"
