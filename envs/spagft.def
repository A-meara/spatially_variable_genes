Bootstrap: localimage
From: python_base_ob.sif

%post
    # Install system dependencies
    apt-get update && apt-get install -y \
        git \
        procps \
        libhdf5-dev \
        cmake

    # Clone SpaGFT
    git clone https://github.com/jxLiu-bio/SpaGFT.git /opt/SpaGFT

    # Fix SpaGFT's setup.py to use compatible versions for Python 3.12
    sed -i "s/numba==0.55.1/numba>=0.56.0/g" /opt/SpaGFT/setup.py
    sed -i "s/networkx==2.8/networkx>=2.8/g" /opt/SpaGFT/setup.py
    sed -i "s/scanpy==1.9.1/scanpy>=1.9.1/g" /opt/SpaGFT/setup.py

    # Install Python packages
    pip install --no-cache-dir --break-system-packages \
        h5py \
        louvain \
        chardet \
        charset-normalizer \
        /opt/SpaGFT \
        mizani \
        pyyaml

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%labels
    Author "OpenProblems/Aidan Meara"
    Version "1.0.0"
    Description "SpaGFT method for spatially variable gene detection"
    BaseImage "python_base_ob.sif (Python 3.12)"
