Bootstrap: docker
From: nvidia/cuda:12.6.3-cudnn9-devel-ubuntu24.04

%post
    # Set up environment
    export DEBIAN_FRONTEND=noninteractive
    export TORCH_CUDA_ARCH_LIST="7.0 7.5 8.0 8.6 8.9 9.0+PTX"

    # Install system packages
    apt-get update && apt-get install -y \
        python3.12 \
        python3.12-dev \
        python3-pip \
        python-is-python3 \
        procps \
        git \
        wget \
        build-essential \
        && rm -rf /var/lib/apt/lists/*

    # Install PyTorch with CUDA support
    pip install --no-cache-dir \
        torch==2.6.0 \
        torchvision==0.20.0 \
        torchaudio==2.6.0 \
        --index-url https://download.pytorch.org/whl/cu126

    # Install Python packages
    pip install --no-cache-dir \
        "anndata~=0.11.0" \
        "scanpy~=1.11.0" \
        pyyaml \
        requests \
        jsonschema

    # Install openproblems-bio/core package from GitHub
    pip install --no-cache-dir \
        "git+https://github.com/openproblems-bio/core.git#subdirectory=packages/python/openproblems"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

%labels
    Author "Aidan Meara"
    Version "1.0"
    Description "PyTorch 2.6.0 with CUDA 12.6.3 and Python 3.12 (built on nvidia/cuda base)"
    BaseImage "nvidia/cuda:12.6.3-cudnn9-devel-ubuntu24.04"
    Python "3.12"
    PyTorch "2.6.0"
    CUDA "12.6.3"
