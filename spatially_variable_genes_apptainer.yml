## benchmark header info
id: spatial_variable_genes_benchmark
description: Benchmark for evaluating spatially variable gene detection methods on spatial transcriptomics data
version: 1.0
benchmarker: "Aidan Meara"
storage_api: S3
## S3 endpoint to share our benchmark results.
storage: https://s3_object_storage_url.ch
benchmark_yaml_spec: 0.01
software_backend: apptainer

## Software environment recipes associated to this benchmark.
##  These are apptainer .sif images converted from OpenProblems Docker containers
software_environments:
  python_base:
    description: "Python base environment with anndata for data loading"
    apptainer: envs/python_base_ob.sif
    conda: envs/ob_example_clustering.yml
  boostgp:
    description: "BOOST-GP method environment"
    apptainer: envs/boostgp.sif
    conda: envs/ob_example_clustering.yml
  random_ranking:
    description: "Random ranking control method"
    apptainer: envs/python_base_ob.sif
    conda: envs/ob_example_clustering.yml
  true_ranking:
    description: "True ranking control method"
    apptainer: envs/python_base_ob.sif
    conda: envs/ob_example_clustering.yml
  correlation:
    description: "Correlation metric environment"
    apptainer: envs/python_base_ob.sif
    conda: envs/ob_example_clustering.yml
  gpcounts:
    description: "GPcounts method environment"
    apptainer: envs/gpcounts.sif
    conda: envs/ob_example_clustering.yml
  moran_i:
    description: "Moran's I method environment"
    apptainer: envs/moran_i.sif
    conda: envs/ob_example_clustering.yml
  nnsvg:
    description: "nnSVG method environment"
    apptainer: envs/nnsvg.sif
    conda: envs/ob_example_clustering.yml
  scgco:
    description: "scGCO method environment"
    apptainer: envs/scgco.sif
    conda: envs/ob_example_clustering.yml
  sepal:
    description: "Sepal method environment"
    apptainer: envs/sepal.sif
    conda: envs/ob_example_clustering.yml
  somde:
    description: "SomDE method environment"
    apptainer: envs/somde.sif
    conda: envs/ob_example_clustering.yml
  spagcn:
    description: "SpaGCN method environment"
    apptainer: envs/spagcn.sif
    conda: envs/ob_example_clustering.yml
  spagft:
    description: "SpaGFT method environment"
    apptainer: envs/spagft.sif
    conda: envs/ob_example_clustering.yml
  spanve:
    description: "SPANVE method environment"
    apptainer: envs/spanve.sif
    conda: envs/ob_example_clustering.yml
  spark:
    description: "SPARK method environment"
    apptainer: envs/spark.sif
    conda: envs/ob_example_clustering.yml
  spark_x:
    description: "SPARK-X method environment"
    apptainer: envs/spark_x.sif
    conda: envs/ob_example_clustering.yml
  spatialde:
    description: "SpatialDE method environment"
    apptainer: envs/spatialde.sif
    conda: envs/ob_example_clustering.yml
  spatialde2:
    description: "SpatialDE2 method environment"
    apptainer: envs/spatialde2.sif
    conda: envs/ob_example_clustering.yml

## Metric collectors - aggregate scores from all metrics, methods, and datasets
metric_collectors:
  - id: scoring
    name: "Score Aggregation"
    software_environment: "python_base"
    repository:
      url: https://github.com/A-meara/metric_collector_SVG
      commit: main
    inputs:
      - metrics.scores
    outputs:
      - id: scoring.csv
        path: "{input}/{name}/aggregated_scores.csv"

stages:
  ## Data stage - loads spatial transcriptomics datasets
  - id: data
    modules:
      ## Mouse and Human datasets
      - id: load_spatial_data
        name: "my_data_loader"
        software_environment: "python_base"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          ## uncomment datasets when ready to run full benchmark

          ## spatial_10x_visium (20 datasets)
          - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/mouse_brain_coronal_section1", "--dataset_name", "mouse_brain_coronal_section1", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_heart", "--dataset_name", "human_heart", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_brain_cancer", "--dataset_name", "human_brain_cancer", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_breast_cancer_1", "--dataset_name", "human_breast_cancer_1", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_breast_cancer_2", "--dataset_name", "human_breast_cancer_2", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_cerebellum", "--dataset_name", "human_cerebellum", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_cervical_cancer", "--dataset_name", "human_cervical_cancer", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_colorectal_cancer", "--dataset_name", "human_colorectal_cancer", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_heart_myocardial_infarction_1", "--dataset_name", "human_heart_myocardial_infarction_1", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_heart_myocardial_infarction_2", "--dataset_name", "human_heart_myocardial_infarction_2", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_intestinal_cancer", "--dataset_name", "human_intestinal_cancer", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_kidney", "--dataset_name", "human_kidney", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_lung_cancer", "--dataset_name", "human_lung_cancer", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_lymph_node", "--dataset_name", "human_lymph_node", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_normal_prostate", "--dataset_name", "human_normal_prostate", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_prostate_cancer", "--dataset_name", "human_prostate_cancer", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/human_skin_melanoma", "--dataset_name", "human_skin_melanoma", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/mouse_embryo", "--dataset_name", "mouse_embryo", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/mouse_kidney_v1", "--dataset_name", "mouse_kidney_v1", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_visium/mouse_olfactory_bulb", "--dataset_name", "mouse_olfactory_bulb", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]

          ## spatial_10x_xenium (2 datasets)
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_xenium/human_colon_cancer", "--dataset_name", "human_colon_cancer", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_10x_xenium/mouse_brain", "--dataset_name", "mouse_brain", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]

          ## spatial_dbit_seq (6 datasets)
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_dbit_seq/mouse_e10_brain", "--dataset_name", "mouse_e10_brain", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_dbit_seq/mouse_e10_eye", "--dataset_name", "mouse_e10_eye", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_dbit_seq/mouse_e10_whole_body", "--dataset_name", "mouse_e10_whole_body", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_dbit_seq/mouse_e11_1", "--dataset_name", "mouse_e11_1", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_dbit_seq/mouse_e11_2", "--dataset_name", "mouse_e11_2", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_dbit_seq/mouse_e11_lower_body", "--dataset_name", "mouse_e11_lower_body", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]

          ## spatial_merfish (5 datasets)
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_merfish/human_cortex_1", "--dataset_name", "human_cortex_1", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_merfish/human_cortex_2", "--dataset_name", "human_cortex_2", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_merfish/human_cortex_3", "--dataset_name", "human_cortex_3", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_merfish/human_cortex_4", "--dataset_name", "human_cortex_4", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_merfish/mouse_cortex", "--dataset_name", "mouse_cortex", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]

          ## spatial_seqfish (1 dataset)
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_seqfish/mouse_organogenesis", "--dataset_name", "mouse_organogenesis", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]

          ## spatial_slideseq_v2 (5 datasets)
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_slideseq_v2/mouse_cerebellum", "--dataset_name", "mouse_cerebellum", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_slideseq_v2/mouse_cortex", "--dataset_name", "mouse_cortex", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_slideseq_v2/mouse_hippocampus_puck", "--dataset_name", "mouse_hippocampus_puck", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_slideseq_v2/mouse_olfactory_bulb_puck", "--dataset_name", "mouse_olfactory_bulb_puck", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_slideseq_v2/mouse_somatosensory_cortex_puck", "--dataset_name", "mouse_somatosensory_cortex_puck", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]

          ## spatial_slide_tags (4 datasets)
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_slide_tags/human_cortex", "--dataset_name", "human_cortex", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_slide_tags/human_skin_melanoma", "--dataset_name", "human_skin_melanoma", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_slide_tags/human_tonsil", "--dataset_name", "human_tonsil", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_slide_tags/mouse_embryo", "--dataset_name", "mouse_embryo", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]

          ## spatial_star_map (2 datasets)
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_star_map/mouse_brain_2d_zstep10_0", "--dataset_name", "mouse_brain_2d_zstep10_0", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_star_map/mouse_brain_2d_zstep15_0", "--dataset_name", "mouse_brain_2d_zstep15_0", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]

          ## spatial_stereo_seq (5 datasets)
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_stereo_seq/drosophila_embryo_e10", "--dataset_name", "drosophila_embryo_e10", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_stereo_seq/drosophila_embryo_e5_6", "--dataset_name", "drosophila_embryo_e5_6", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_stereo_seq/drosophila_embryo_e6_3", "--dataset_name", "drosophila_embryo_e6_3", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_stereo_seq/drosophila_embryo_e7", "--dataset_name", "drosophila_embryo_e7", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]
          # - values: ["--component", "data_loader", "--dataset_id", "spatial_stereo_seq/drosophila_embryo_e9_1", "--dataset_name", "drosophila_embryo_e9_1", "--data_source_dir", "/home/ameara/porting/spatially_variable_genes/datasets"]


    ## Data stage outputs
    outputs:
      - id: data.dataset
        path: "{input}/{stage}/{module}/{params}/{dataset}.dataset.h5ad"
      - id: data.solution
        path: "{input}/{stage}/{module}/{params}/{dataset}.solution.h5ad"

  ## Methods stage - SVG detection methods
  - id: methods
    modules:
      ## Control methods
      - id: random_ranking
        name: "Random Ranking"
        software_environment: "random_ranking"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/random_ranking", "--seed", "42"]

      - id: true_ranking
        name: "True Ranking"
        software_environment: "true_ranking"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/true_ranking"]

      ## R-based methods
      - id: boostgp
        name: "BOOST-GP"
        software_environment: "boostgp"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/boostgp", "--n_iter", "10"]

      - id: nnsvg
        name: "nnSVG"
        software_environment: "nnsvg"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/nnsvg", "--n_threads", "1"]

      - id: spark
        name: "SPARK"
        software_environment: "spark"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/spark", "--num_cores", "1"]

      - id: spark_x
        name: "SPARK-X"
        software_environment: "spark_x"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/spark_x", "--num_cores", "4"]

      ## Python-based methods
      - id: gpcounts
        name: "GPcounts"
        software_environment: "gpcounts"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/gpcounts"]

      - id: moran_i
        name: "Moran's I"
        software_environment: "moran_i"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/moran_i", "--coord_type_moran_i", "generic"]

      - id: scgco
        name: "scGCO"
        software_environment: "scgco"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/scgco"]

      - id: sepal
        name: "Sepal"
        software_environment: "sepal"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/sepal", "--coord_type_sepal", "grid", "--max_neighs_sepal", "6"]

      - id: somde
        name: "SomDE"
        software_environment: "somde"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/somde"]

      - id: spagcn
        name: "SpaGCN"
        software_environment: "spagcn"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/spagcn"]

      - id: spagft
        name: "SpaGFT"
        software_environment: "spagft"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/spagft"]

      - id: spanve
        name: "SPANVE"
        software_environment: "spanve"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/spanve"]

      - id: spatialde
        name: "SpatialDE"
        software_environment: "spatialde"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/spatialde"]

      - id: spatialde2
        name: "SpatialDE2"
        software_environment: "spatialde2"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "methods/spatialde2"]


    ## Methods consume data stage outputs
    inputs:
      - entries:
          - data.dataset
          - data.solution  # Needed for control methods

    ## Methods stage outputs
    outputs:
      - id: methods.predictions
        path: "{input}/{stage}/{module}/{params}/{dataset}.predictions.h5ad"

  ## Metrics stage - evaluate predictions
  - id: metrics
    modules:
      - id: correlation
        name: "Kendall Correlation"
        software_environment: "correlation"
        repository:
          url: https://github.com/A-meara/spatially_variable_genes
          commit: main
        parameters:
          - values: ["--component", "metrics/correlation"]

    ## Metrics consume method predictions and ground truth
    inputs:
      - entries:
          - methods.predictions
          - data.solution

    ## Metrics stage outputs
    outputs:
      - id: metrics.scores
        path: "{input}/{stage}/{module}/{params}/{dataset}.scores.h5ad"
